const moduleLoader={initialized:!1,modules:{},initPromise:null,retryCount:0,maxRetries:3,async init(){return this.initialized?this.modules:(this.initPromise||(this.initPromise=this._initializeWithRetry()),this.initPromise)},async _initializeWithRetry(){try{return console.log("üîÑ Initializing shared modules..."),this._validateExtensionContext()?(await this._waitForDependencies(),this.modules.errorHandler||(this.modules.errorHandler=void 0!==window.ErrorHandler?new window.ErrorHandler:this._createFallbackErrorHandler()),this.modules.fallbackStorage||(this.modules.fallbackStorage=void 0!==window.FallbackStorage?new window.FallbackStorage:this._createFallbackStorage(),this.modules.fallbackStorage&&this.modules.fallbackStorage.init&&await this.modules.fallbackStorage.init()),this.modules.connectionManager||(this.modules.connectionManager=void 0!==window.ConnectionManager?new window.ConnectionManager(this.modules.errorHandler):this._createFallbackConnectionManager()),this.initialized=!0,console.log("‚úÖ Shared modules initialized successfully"),this.modules):(console.warn("‚ö†Ô∏è Extension context not fully available, using fallback modules"),this._initializeFallbackModules())}catch(e){if(console.error("‚ùå Failed to initialize shared modules:",e),this.retryCount<this.maxRetries){this.retryCount++;const e=500*Math.pow(2,this.retryCount);return console.log(`üîÑ Retrying shared module initialization in ${e}ms (attempt ${this.retryCount}/${this.maxRetries})`),await new Promise(i=>setTimeout(i,e)),this.initPromise=null,this.init()}return console.warn("‚ö†Ô∏è Max retries reached, initializing fallback modules for degraded functionality"),this._initializeFallbackModules()}},async _waitForDependencies(){const e=Date.now();for(;Date.now()-e<5e3;){const e=void 0!==window.ErrorHandler,i=void 0!==window.FallbackStorage,o=void 0!==window.ConnectionManager;if(e&&i&&o)return void console.log("üì¶ All dependencies loaded");await new Promise(e=>setTimeout(e,100))}console.warn("‚è∞ Timeout waiting for dependencies, proceeding with partial initialization")},_validateExtensionContext(){try{return!!(chrome&&chrome.runtime&&chrome.storage)}catch(e){return!1}},_initializeFallbackModules(){return console.log("üèóÔ∏è Initializing fallback modules..."),this.modules.errorHandler||(this.modules.errorHandler=this._createFallbackErrorHandler()),this.modules.fallbackStorage||(this.modules.fallbackStorage=this._createFallbackStorage()),this.modules.connectionManager||(this.modules.connectionManager=this._createFallbackConnectionManager()),this.initialized=!0,console.log("‚ö†Ô∏è Fallback modules initialized (limited functionality)"),this.modules},_createFallbackErrorHandler:()=>({handleError:(e,i)=>{console.error("Error (fallback mode):",e,i)},showErrorNotification:e=>{console.warn("Notification (fallback mode):",e)},logError:(e,i)=>{console.error("Log (fallback mode):",e,i)},reportError:(e,i)=>{console.error("Report (fallback mode):",e,i)}}),_createFallbackStorage:()=>({init:async()=>{console.log("üì¶ Fallback storage initialized")},storeAnalytics:async(e,i,o)=>{console.log("üìä Analytics storage not available (fallback mode):",{domain:e,date:i,data:o})},getAnalytics:async()=>(console.log("üìä Analytics retrieval not available (fallback mode)"),[]),getSettings:async()=>(console.log("‚öôÔ∏è Settings retrieval not available (fallback mode)"),{isEnabled:!1,focusMode:"gentle",thresholds:{stage1:30,stage2:60,stage3:120,stage4:180},whitelist:[]}),storeSettings:async e=>{console.log("‚öôÔ∏è Settings storage not available (fallback mode):",e)}}),_createFallbackConnectionManager:()=>({contextValid:!1,isConnected:!1,sendMessage:async e=>{throw console.log("üì° Message sending not available (fallback mode):",e),new Error("Connection not available in fallback mode")},onConnectionChange:()=>{},onContextInvalid:()=>{},validateContext:()=>!1,connect:async()=>!1,disconnect:()=>{},queueMessage:e=>{console.log("üì° Message queuing not available (fallback mode):",e)}}),async getModule(e){return this.initialized||await this.init(),this.modules[e]||null},async getModules(){return this.initialized||await this.init(),{...this.modules}},getStatus(){return{initialized:this.initialized,retryCount:this.retryCount,hasErrorHandler:!!this.modules.errorHandler,hasConnectionManager:!!this.modules.connectionManager,hasFallbackStorage:!!this.modules.fallbackStorage,contextValid:this._validateExtensionContext()}},async reset(){return this.initialized=!1,this.initPromise=null,this.retryCount=0,this.modules={},console.log("üîÑ Shared modules reset, re-initializing..."),this.init()}};setTimeout(()=>{moduleLoader.init().catch(e=>{console.warn("Failed to auto-initialize shared modules:",e)})},200),"undefined"!=typeof module&&module.exports?module.exports=moduleLoader:window.SharedModules=moduleLoader,console.log("üì¶ Shared module loader ready");