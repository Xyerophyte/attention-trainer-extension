class ErrorHandler{constructor(){this.errorLog=[],this.maxLogSize=100,this.errorListeners=[],this.initialized=!1,this.errorCategories={CONTEXT:"context_invalidation",CONNECTION:"connection_failure",STORAGE:"storage_operation",RUNTIME:"runtime_error",MESSAGING:"messaging_error",DOM:"dom_operation",API:"chrome_api",UNKNOWN:"unknown"},this.init()}init(){this.initialized||(this.setupGlobalErrorHandler(),this.setupPromiseRejectionHandler(),this.initialized=!0,console.log("üõ°Ô∏è Error handler initialized"))}setupGlobalErrorHandler(){if("undefined"!=typeof window){const r=window.onerror;window.onerror=(e,t,o,n,i)=>(this.handleError(i||new Error(e),{source:t,line:o,column:n,context:"window.onerror"}),"function"==typeof r&&r(e,t,o,n,i))}}setupPromiseRejectionHandler(){"undefined"!=typeof window&&window.addEventListener("unhandledrejection",r=>{const e=r.reason instanceof Error?r.reason:new Error(String(r.reason));this.handleError(e,{context:"unhandledrejection",isCritical:!0})})}handleError(r,e={}){const t=this.categorizeError(r),o=Date.now(),n={message:r.message,stack:r.stack,category:t,timestamp:o,metadata:{...e,userAgent:navigator?.userAgent,url:window?.location?.href}};return this.errorLog.unshift(n),this.errorLog.length>this.maxLogSize&&this.errorLog.pop(),console.error(`üõë [${t}] ${r.message}`,r,e),this.notifyErrorListeners(n),this.persistError(n),n}categorizeError(r){const e=r?.message?.toLowerCase()||"";return e.includes("context invalidated")||e.includes("receiving end does not exist")?this.errorCategories.CONTEXT:e.includes("connection")||e.includes("network")||e.includes("timeout")?this.errorCategories.CONNECTION:e.includes("storage")||e.includes("database")||e.includes("indexeddb")?this.errorCategories.STORAGE:e.includes("messaging")||e.includes("port closed")?this.errorCategories.MESSAGING:e.includes("dom")||e.includes("element")?this.errorCategories.DOM:e.includes("chrome")||e.includes("api")||e.includes("runtime")?this.errorCategories.API:this.errorCategories.UNKNOWN}subscribeToErrors(r){if("function"!=typeof r)throw new Error("Error listener must be a function");return this.errorListeners.push(r),()=>this.unsubscribeFromErrors(r)}unsubscribeFromErrors(r){this.errorListeners=this.errorListeners.filter(e=>e!==r)}notifyErrorListeners(r){this.errorListeners.forEach(e=>{try{e(r)}catch(r){console.error("Error in error listener:",r)}})}async persistError(r){try{if(window.FallbackStorage){const e=new window.FallbackStorage;await e.init();const t=(new Date).toISOString().split("T")[0];await e.storeAnalytics("errors",t,{errors:[r]})}}catch(r){console.warn("Failed to persist error:",r)}}getErrorLog(){return[...this.errorLog]}clearErrorLog(){this.errorLog=[]}getErrorStats(){const r={};return Object.values(this.errorCategories).forEach(e=>{r[e]=this.errorLog.filter(r=>r.category===e).length}),r.total=this.errorLog.length,r.recentErrors=this.errorLog.slice(0,5),r}async retry(r,e={}){const{maxRetries:t=3,baseDelay:o=1e3,factor:n=2,jitter:i=!0,onRetry:s=null,retryableErrors:a=null}=e;let c=0;for(;;)try{return await r(c)}catch(r){c++;if(!(!a||a.some(e=>r.message.includes(e)))||c>=t)throw this.handleError(r,{context:"retry",attempts:c,maxRetries:t}),r;const e=o*Math.pow(n,c-1),l=i?e*(.5+Math.random()):e;if(s)try{s(r,c,l)}catch(r){console.warn("Error in retry callback:",r)}console.warn(`‚è≥ Retry attempt ${c}/${t} in ${Math.round(l)}ms...`),await new Promise(r=>setTimeout(r,l))}}wrap(r,e={}){return async(...t)=>{try{return await r(...t)}catch(r){throw this.handleError(r,{...e,arguments:t.map(r=>"object"==typeof r?r?Object.keys(r):null:typeof r)}),r}}}circuitBreaker(r,e={}){const{maxFailures:t=3,resetTimeout:o=3e4,onOpen:n=null,onClose:i=null,fallback:s=null}=e;let a=0,c=!1,l=0;return async(...e)=>{if(c){if(!(Date.now()-l>o)){if(s)return s(...e);throw new Error("Circuit breaker is open")}if(c=!1,a=0,i)try{i()}catch(r){console.warn("Error in circuit breaker close callback:",r)}}try{const t=await r(...e);return a=0,t}catch(r){if(a++,l=Date.now(),a>=t&&(c=!0,n))try{n(r)}catch(r){console.warn("Error in circuit breaker open callback:",r)}if(this.handleError(r,{context:"circuitBreaker",failures:a,isOpen:c}),s&&c)return s(...e);throw r}}}showErrorNotification(r,e=5e3){if("undefined"==typeof document)return;let t=document.getElementById("error-notification-container");t||(t=document.createElement("div"),t.id="error-notification-container",t.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        z-index: 9999999;\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n      ",document.body.appendChild(t));const o=document.createElement("div");return o.className="error-notification",o.style.cssText="\n      background: #ef4444;\n      color: white;\n      padding: 12px 16px;\n      border-radius: 8px;\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      max-width: 350px;\n      animation: fadeIn 0.3s ease;\n      transition: opacity 0.3s ease, transform 0.3s ease;\n    ",o.innerHTML=`\n      <div style="font-size: 20px;">‚ö†Ô∏è</div>\n      <div style="flex-grow: 1;">${r}</div>\n      <div style="cursor: pointer; padding: 4px;" onclick="this.parentElement.remove()">‚úï</div>\n    `,t.appendChild(o),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateX(20px)",setTimeout(()=>o.remove(),300)},e),o}}"undefined"!=typeof module&&module.exports?module.exports=ErrorHandler:window.ErrorHandler=ErrorHandler;