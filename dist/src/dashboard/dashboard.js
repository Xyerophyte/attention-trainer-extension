class AttentionTrainerDashboard{constructor(){this.settings={},this.charts={},this.init()}async init(){try{await this.loadSettings(),this.setupEventListeners(),this.renderStats(),this.renderCharts(),this.renderSitesTable()}catch(e){console.error("Failed to initialize dashboard:",e),this.showError("Failed to load dashboard data")}}async loadSettings(){try{const e=await chrome.runtime.sendMessage({type:"GET_SETTINGS"});this.settings=e||{analytics:{dailyStats:{},interventions:[]}}}catch(e){console.error("Failed to load settings:",e),this.settings={analytics:{dailyStats:{},interventions:[]}},this.showError("Could not connect to extension data")}}setupEventListeners(){document.getElementById("timeRange").addEventListener("change",e=>{this.updateTimeRange(Number.parseInt(e.target.value))})}renderStats(){const e=(this.settings.analytics||{}).dailyStats||{},t=this.getLast7Days();let n=0,r=0;const i={};t.forEach(t=>{const o=e[t]||{};Object.entries(o).forEach(([e,t])=>{const o=t.timeOnPage||t.scrollTime||0;n+=o,r+=t.interventions||0,i[e]||(i[e]={timeOnPage:0,scrollTime:0,interventions:0,behaviorScore:0,siteType:"general"}),i[e].timeOnPage+=t.timeOnPage||0,i[e].scrollTime+=t.scrollTime||0,i[e].interventions+=t.interventions||0,i[e].behaviorScore=Math.max(i[e].behaviorScore,t.behaviorScore||0),i[e].siteType=t.siteType||"general"})});const o=Math.round(n/60),a=o>60?`${Math.round(o/60)}h ${o%60}m`:`${o}m`;document.getElementById("totalScrollTime").textContent=a,document.getElementById("totalInterventions").textContent=r;const s=Object.values(i).reduce((e,t)=>e+t.behaviorScore,0)/Math.max(Object.keys(i).length,1),l=Math.max(0,100-2*r-.5*s);document.getElementById("focusScore").textContent=`${Math.round(l)}%`;const d=Object.entries(i).sort(([,e],[,t])=>{const n=(e.behaviorScore||0)+(e.timeOnPage||e.scrollTime||0)/60;return(t.behaviorScore||0)+(t.timeOnPage||t.scrollTime||0)/60-n})[0];if(d){document.getElementById("topDistractingSite").textContent=d[0];const e=Math.round((d[1].timeOnPage||d[1].scrollTime||0)/60),t=d[1].siteType||"general";document.getElementById("topSiteTime").textContent=`${e} minutes this week (${t})`}else document.getElementById("topDistractingSite").textContent="None",document.getElementById("topSiteTime").textContent="No data yet"}renderCharts(){this.renderScrollTrendChart(),this.renderInterventionChart()}renderScrollTrendChart(){try{const e=document.getElementById("scrollTrendChart"),t=this.getLast7Days(),n=this.settings.analytics?.dailyStats||{},r=t.map(e=>{const t=n[e]||{};return Object.values(t).reduce((e,t)=>e+(t.timeOnPage||(t.scrollTime||0)/60),0)}),i=Math.max(...r,1),o=`\n        <div style="padding: 20px; background: #f8fafc; border-radius: 8px;">\n          <h4 style="margin: 0 0 15px 0; color: #374151;">Scroll Time (Last 7 Days)</h4>\n          ${t.map((e,t)=>{const n=new Date(e).toLocaleDateString("en-US",{weekday:"short"}),o=r[t];return`\n              <div style="margin: 8px 0; display: flex; align-items: center;">\n                <div style="width: 30px; font-size: 12px; color: #6b7280;">${n}</div>\n                <div style="flex: 1; margin: 0 10px; background: #e5e7eb; border-radius: 4px; height: 20px; position: relative;">\n                  <div style="background: #3b82f6; height: 100%; width: ${o/i*100}%; border-radius: 4px;"></div>\n                </div>\n                <div style="width: 40px; font-size: 12px; color: #374151; text-align: right;">${Math.round(o)}m</div>\n              </div>\n            `}).join("")}\n        </div>\n      `;e.outerHTML=`<div id="scrollTrendChart">${o}</div>`}catch(e){console.error("Failed to render scroll trend chart:",e),document.getElementById("scrollTrendChart").innerHTML='<p style="text-align: center; padding: 20px; color: #ef4444;">Chart failed to load</p>'}}renderInterventionChart(){try{const e=document.getElementById("interventionChart"),t=this.settings.analytics?.interventions||[],n={1:0,2:0,3:0,4:0};t.forEach(e=>{n[e.stage]++});const r=["Stage 1 (Dim)","Stage 2 (Blur)","Stage 3 (Nudge)","Stage 4 (Lock)"],i=["#fbbf24","#f59e0b","#d97706","#dc2626"],o=Object.values(n).reduce((e,t)=>e+t,0),a=`\n        <div style="padding: 20px; background: #f8fafc; border-radius: 8px;">\n          <h4 style="margin: 0 0 15px 0; color: #374151;">Interventions by Stage</h4>\n          ${0===o?'<p style="text-align: center; color: #6b7280; margin: 20px 0;">No interventions yet</p>':Object.entries(n).map(([e,t],n)=>{const a=o>0?Math.round(t/o*100):0;return`\n                <div style="margin: 10px 0; display: flex; align-items: center;">\n                  <div style="width: 15px; height: 15px; background: ${i[n]}; border-radius: 3px; margin-right: 10px;"></div>\n                  <div style="flex: 1; font-size: 14px; color: #374151;">${r[n]}</div>\n                  <div style="width: 60px; text-align: right; font-size: 14px; color: #6b7280;">${t} (${a}%)</div>\n                </div>\n              `}).join("")}\n        </div>\n      `;e.outerHTML=`<div id="interventionChart">${a}</div>`}catch(e){console.error("Failed to render intervention chart:",e),document.getElementById("interventionChart").innerHTML='<p style="text-align: center; padding: 20px; color: #ef4444;">Chart failed to load</p>'}}renderSitesTable(){const e=this.settings.analytics?.dailyStats||{},t=this.getLast7Days(),n={};t.forEach(t=>{const r=e[t]||{};Object.entries(r).forEach(([e,t])=>{n[e]||(n[e]={timeOnPage:0,scrollTime:0,interventions:0,behaviorScore:0,siteType:"general",flags:{}}),n[e].timeOnPage+=t.timeOnPage||0,n[e].scrollTime+=t.scrollTime||0,n[e].interventions+=t.interventions||0,n[e].behaviorScore=Math.max(n[e].behaviorScore,t.behaviorScore||0),n[e].siteType=t.siteType||"general",t.flags&&Object.keys(t.flags).forEach(r=>{n[e].flags[r]=(n[e].flags[r]||0)+(t.flags[r]||0)})})});const r=Object.entries(n).sort(([,e],[,t])=>{const n=(e.behaviorScore||0)+(e.timeOnPage||e.scrollTime||0)/60;return(t.behaviorScore||0)+(t.timeOnPage||t.scrollTime||0)/60-n}).slice(0,10),i=document.getElementById("sitesTableBody");i.innerHTML="",0===r.length?i.innerHTML='<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6b7280;">No data available yet. Start browsing to see analytics!</td></tr>':r.forEach(([e,t])=>{const n=document.createElement("tr"),r=Math.round((t.timeOnPage||t.scrollTime||0)/(t.timeOnPage?1:60)),o=this.calculateRiskLevel(t.interventions,r,t.behaviorScore||0),a=t.siteType||"general",s=Math.round(t.behaviorScore||0);n.innerHTML=`\n          <td class="site-name">${e} <span style="font-size: 11px; color: #6b7280;">(${a})</span></td>\n          <td>${r}m <br><small style="color: #6b7280;">Score: ${s}</small></td>\n          <td>${t.interventions}</td>\n          <td class="risk-${o.toLowerCase()}">${o}</td>\n        `,i.appendChild(n)})}calculateRiskLevel(e,t,n=0){const r=e+t/30+n/20;return r>10?"High":r>5?"Medium":"Low"}getLast7Days(){const e=[];for(let t=6;t>=0;t--){const n=new Date;n.setDate(n.getDate()-t),e.push(n.toISOString().split("T")[0])}return e}async updateTimeRange(e){this.renderStats(),this.renderCharts(),this.renderSitesTable()}showError(e){const t=document.querySelector(".container"),n=document.createElement("div");n.style.cssText="\n      background: #fee;\n      color: #c53030;\n      padding: 12px;\n      border-radius: 8px;\n      margin-bottom: 20px;\n      text-align: center;\n    ",n.textContent=e,t.insertBefore(n,t.firstChild),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},5e3)}}new AttentionTrainerDashboard;