class AttentionTrainerContent{constructor(){this.connectionManager=null,this.errorHandler=null,this.fallbackStorage=null,this.contextValid=!0,this.backgroundConnected=!1,this.behaviorData={sessionStart:Date.now(),totalTimeOnPage:0,scrollSessions:[],currentScrollSession:null,rapidScrollCount:0,shortStayCount:0,backAndForthCount:0,passiveConsumptionTime:0,interventionStage:0,lastInterventionTime:0,focusMode:!1,snoozeUntil:null,flags:{},contentPieces:0},this.scrollData={isScrolling:!1,startTime:0,totalScrollTime:0,scrollDistance:0,interventionStage:0,focusMode:!1,snoozeUntil:null},this.sitePatterns=this.detectSitePattern(),this.behaviorScore=0,this.interventionOverlay=null,this.behaviorTimeout=null,this.settings={},this.observers=[],this.init()}async init(){try{await this.initializeSharedModules(),await this.loadSettings(),this.setupBehavioralAnalysis(),this.setupMessageListener(),this.createInterventionElements(),this.startBehaviorTracking(),console.log(`üéØ Attention Trainer initialized for ${this.sitePatterns.type} site`)}catch(e){this.errorHandler?this.errorHandler.handleError(e,{context:"content_init"}):console.error("Failed to initialize Attention Trainer:",e)}}async initializeSharedModules(){const e=Date.now();try{for(;!window.SharedModules&&Date.now()-e<5e3;)await new Promise(e=>setTimeout(e,100));if(void 0!==window.SharedModules){console.log("üîó Connecting to shared modules...");const e=window.SharedModules.getModules(),t=new Promise((e,t)=>setTimeout(()=>t(new Error("Module initialization timeout")),3e3)),n=await Promise.race([e,t]);this.errorHandler=n.errorHandler,this.connectionManager=n.connectionManager,this.fallbackStorage=n.fallbackStorage;const i=window.SharedModules.getStatus();return console.log("üìä Shared module status:",i),this.connectionManager&&(this.connectionManager.onConnectionChange=e=>{this.backgroundConnected=e,this.contextValid=this.connectionManager.contextValid,console.log("üì° Connection state changed: "+(e?"connected":"disconnected"))},this.connectionManager.onContextInvalid=e=>{this.handleContextInvalidation(e)}),console.log("‚úÖ Shared modules initialized in content script"),!0}return console.warn("‚ö†Ô∏è Shared modules not available after timeout, using legacy mode"),!1}catch(e){return console.error("Failed to initialize shared modules:",e),this.errorHandler&&this.errorHandler.handleError(e,{context:"content_shared_modules_init"}),!1}}handleContextInvalidation(e=!1){if(e?console.info("üîÑ Extension context temporarily invalid (likely during reload)"):console.warn("üö® Extension context invalidated in content script"),this.contextValid=!1,this.backgroundConnected=!1,e||this.cleanupObservers(),this.fallbackStorage)try{this.saveBehaviorDataToFallback()}catch(e){console.warn("Failed to save to fallback storage:",e)}this.errorHandler&&!e?this.errorHandler.showErrorNotification("Extension was updated or disabled. Please refresh this page to restore full functionality.",{type:"warning",duration:8e3}):e&&this.showReloadNotification()}showReloadNotification(){const e=document.createElement("div");e.style.cssText="\n      position: fixed; top: 20px; right: 20px; \n      background: rgba(59, 130, 246, 0.9); \n      color: white; padding: 12px 16px; \n      border-radius: 8px; z-index: 999999;\n      font-size: 14px; font-family: system-ui, sans-serif;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      max-width: 300px; line-height: 1.4;\n    ",e.innerHTML='\n      <div style="display: flex; align-items: center; gap: 8px;">\n        <span style="font-size: 16px;">üîÑ</span>\n        <div>\n          <div style="font-weight: 500;">Extension reloaded</div>\n          <div style="font-size: 12px; opacity: 0.9;">Functionality will resume shortly</div>\n        </div>\n      </div>\n    ',document.body.appendChild(e),setTimeout(()=>{e.parentElement&&e.remove()},3e3)}cleanupObservers(){this.observers.forEach(e=>{try{e.disconnect()}catch(e){console.warn("Error disconnecting observer:",e)}}),this.observers=[]}async saveBehaviorDataToFallback(){if(this.fallbackStorage)try{const e=window.location.hostname,t=(new Date).toISOString().split("T")[0];await this.fallbackStorage.storeAnalytics(e,t,{timeOnPage:this.behaviorData.totalTimeOnPage/6e4,behaviorScore:this.behaviorScore,siteType:this.sitePatterns.type,flags:this.behaviorData.flags||{},contentPieces:this.behaviorData.contentPieces||0,scrollPauses:this.behaviorData.scrollPauseCount||0,interventionStage:this.behaviorData.interventionStage,sessionEnd:Date.now()}),console.log("üíæ Behavioral data saved to fallback storage")}catch(e){console.error("Failed to save to fallback storage:",e)}}async loadSettings(){try{if(this.connectionManager&&this.connectionManager.contextValid){const e=await this.connectionManager.sendMessage({type:"GET_SETTINGS"});return this.settings=e||{isEnabled:!0,focusMode:"gentle"},this.backgroundConnected=this.connectionManager.isConnected,void console.log("‚úÖ Settings loaded via connection manager")}}catch(e){console.warn("Connection manager failed, trying direct messaging:",e.message)}let e=0;for(;e<3;)try{if(!chrome?.runtime?.id)throw new Error("Extension context not available");e>0&&await new Promise(t=>setTimeout(t,1e3*e));const t=await chrome.runtime.sendMessage({type:"GET_SETTINGS"});return this.settings=t||{isEnabled:!0,focusMode:"gentle"},this.backgroundConnected=!0,void console.log("‚úÖ Settings loaded via direct messaging")}catch(t){if(e++,t.message.includes("Extension context")||t.message.includes("receiving end does not exist")||t.message.includes("message port closed"))return console.warn("üö® Extension context invalidated during settings load"),this.contextValid=!1,void(this.settings={isEnabled:!1});console.warn(`‚ö†Ô∏è Failed to load settings (attempt ${e}/3):`,t.message),e>=3&&(console.warn("üîå Background service unavailable, using fallback settings"),this.backgroundConnected=!1,this.settings={isEnabled:!0,focusMode:"gentle",thresholds:{stage1:30,stage2:60,stage3:120,stage4:180},whitelist:[]})}}setupMessageListener(){this.contextValid&&chrome.runtime.onMessage.addListener((e,t,n)=>{try{if(!chrome.runtime.id)return void console.warn("Extension context invalidated in message listener")}catch(e){return void console.warn("Extension context check failed:",e.message)}switch(e.type){case"TRIGGER_INTERVENTION":this.triggerIntervention(e.stage,e.focusMode);break;case"RESET_BEHAVIORAL_DATA":this.resetBehaviorData()}})}createInterventionElements(){this.interventionOverlay=document.createElement("div"),this.interventionOverlay.className="attention-trainer-overlay",this.interventionOverlay.style.display="none",document.body.appendChild(this.interventionOverlay)}triggerIntervention(e,t){try{if(!this.contextValid)return void console.warn("Extension context invalid, skipping intervention");if(e===this.behaviorData.interventionStage)return;if(this.behaviorData.interventionStage=e,this.scrollData.interventionStage=e,this.backgroundConnected)try{chrome.runtime.id&&chrome.runtime.sendMessage({type:"INTERVENTION_TRIGGERED",data:{stage:e,timestamp:Date.now()}}).catch(e=>{e.message.includes("Extension context invalidated")?(console.warn("Extension context invalidated during intervention logging"),this.contextValid=!1):console.log("Failed to log intervention:",e.message)})}catch(e){console.warn("Runtime check failed during intervention logging:",e.message)}switch(this.clearIntervention(!1),console.log(`üéØ Triggering intervention stage ${e}`),e){case 1:this.applyEnhancedDimming(),this.showScrollProgress();break;case 2:this.applyProgressiveBlur(),this.addGentleShake();break;case 3:this.showEnhancedNudgeMessage();break;case 4:"strict"===t?this.applyBreathingReminder():this.showFinalWarning();break;default:console.warn("Unknown intervention stage:",e)}}catch(e){console.error("Error triggering intervention:",e)}}applyDimming(){document.body.style.transition="opacity 0.5s ease",document.body.style.opacity="0.8"}applyBlur(){document.querySelectorAll("p, span, div:not([role]), img, video").forEach(e=>{e.style.transition="filter 0.5s ease",e.style.filter="blur(1px)"})}showNudgeMessage(){const e=["üéØ Take a breath. What were you looking for?","‚è∞ You've been scrolling for a while. Time for a break?","üß† Your future self will thank you for focusing now.","‚ú® Great things happen when you stay focused!","üé® What could you create with this time instead?"],t=e[Math.floor(Math.random()*e.length)];this.interventionOverlay.innerHTML=`\n      <div class="attention-trainer-nudge">\n        <div class="nudge-content">\n          <h3>${t}</h3>\n          <div class="nudge-actions">\n            <button class="continue-btn">Continue Browsing</button>\n            <button class="focus-btn">Start Focus Session</button>\n          </div>\n        </div>\n      </div>\n    `,this.interventionOverlay.style.display="flex",this.interventionOverlay.querySelector(".continue-btn").addEventListener("click",()=>{this.clearIntervention()}),this.interventionOverlay.querySelector(".focus-btn").addEventListener("click",()=>{this.startFocusSession()})}applyScrollLock(){document.body.style.overflow="hidden",setTimeout(()=>{document.body.style.overflow="",this.clearIntervention()},5e3)}applyEnhancedDimming(){document.body.classList.add("attention-trainer-dim","attention-trainer-pulse"),document.body.style.opacity="0.75",console.log("üìâ Applied enhanced dimming")}showScrollProgress(){let e=document.getElementById("attention-trainer-progress");e||(e=document.createElement("div"),e.id="attention-trainer-progress",e.className="scroll-progress",document.body.appendChild(e));const t=this.getScrollTime(),n=Math.min(t/15*100,100);e.style.width=`${n}%`}applyProgressiveBlur(){document.querySelectorAll('p, span, div:not([class*="attention-trainer"]), img, video, article, section').forEach(e=>{e.classList.add("attention-trainer-blur"),e.style.filter="blur(2px) brightness(0.8)"}),console.log("üòµ‚Äçüí´ Applied progressive blur")}addGentleShake(){document.body.classList.add("attention-trainer-shake"),setTimeout(()=>{document.body.classList.remove("attention-trainer-shake")},1500)}showEnhancedNudgeMessage(){const e=[{icon:"üéØ",title:"Take a mindful pause",subtitle:"What were you looking for?"},{icon:"‚è∞",title:"Time awareness check",subtitle:"You've been scrolling for a while"},{icon:"üß†",title:"Focus opportunity",subtitle:"Your future self will thank you"},{icon:"‚ú®",title:"Intentional browsing",subtitle:"Great things happen when you stay focused"},{icon:"üå±",title:"Growth moment",subtitle:"What could you create with this time?"}],t=e[Math.floor(Math.random()*e.length)],n=this.getScrollTime(),i=Math.round(this.scrollData.scrollDistance/100);this.interventionOverlay.innerHTML=`\n      <div class="attention-trainer-nudge">\n        <div class="nudge-content">\n          <span class="nudge-icon">${t.icon}</span>\n          <h3>${t.title}</h3>\n          <p class="nudge-subtitle">${t.subtitle}</p>\n          \n          <div class="nudge-stats">\n            <div class="stat-item">\n              <div class="stat-value">${Math.round(n)}s</div>\n              <div class="stat-label">Scrolling</div>\n            </div>\n            <div class="stat-item">\n              <div class="stat-value">${i}</div>\n              <div class="stat-label">Screens</div>\n            </div>\n            <div class="stat-item">\n              <div class="stat-value">${this.scrollData.interventionStage}</div>\n              <div class="stat-label">Stage</div>\n            </div>\n          </div>\n          \n          <div class="nudge-actions">\n            <button class="continue-btn">Continue Browsing</button>\n            <button class="focus-btn">‚ú® Start Focus Mode</button>\n          </div>\n        </div>\n      </div>\n    `,this.interventionOverlay.style.display="flex";const o=this.interventionOverlay.querySelector(".continue-btn"),s=this.interventionOverlay.querySelector(".focus-btn");o.addEventListener("click",()=>{this.clearIntervention(),this.snoozeIntervention(30)}),s.addEventListener("click",()=>{this.startEnhancedFocusSession()}),console.log("üí¨ Showed enhanced nudge message")}applyBreathingReminder(){const e=document.createElement("div");e.className="breathing-reminder",e.innerHTML='\n      <div style="font-size: 24px; margin-bottom: 16px;">ü´Å</div>\n      <h3>Take a deep breath</h3>\n      <p>Inhale... Hold... Exhale...</p>\n      <div style="margin-top: 20px;">\n        <button onclick="this.parentElement.parentElement.remove(); this.clearIntervention();" \n                style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">\n          I\'m ready to focus\n        </button>\n      </div>\n    ',document.body.appendChild(e),setTimeout(()=>{e.parentElement&&(e.remove(),this.clearIntervention())},1e4),console.log("ü´Å Applied breathing reminder")}showFinalWarning(){this.interventionOverlay.innerHTML=`\n      <div class="attention-trainer-nudge" style="border: 3px solid #ef4444;">\n        <div class="nudge-content">\n          <span class="nudge-icon">‚ö†Ô∏è</span>\n          <h3 style="color: #ef4444;">Attention overload detected</h3>\n          <p class="nudge-subtitle">You've been scrolling for ${Math.round(this.getScrollTime())} seconds straight</p>\n          \n          <div class="nudge-actions">\n            <button class="continue-btn">Take a 5-min break</button>\n            <button class="focus-btn">üöÄ Focus Mode Now</button>\n          </div>\n        </div>\n      </div>\n    `,this.interventionOverlay.style.display="flex";const e=this.interventionOverlay.querySelector(".continue-btn"),t=this.interventionOverlay.querySelector(".focus-btn");e.addEventListener("click",()=>{this.startBreakMode()}),t.addEventListener("click",()=>{this.startEnhancedFocusSession()}),console.log("‚ö†Ô∏è Showed final warning")}getScrollTime(){const e=(Date.now()-this.behaviorData.sessionStart)/1e3;return Math.min(e,300)}snoozeIntervention(e){this.behaviorData.snoozeUntil=Date.now()+1e3*e,this.scrollData.snoozeUntil=Date.now()+1e3*e,console.log(`üò¥ Snoozed interventions for ${e} seconds`)}startEnhancedFocusSession(){this.clearIntervention(),this.behaviorData.focusMode=!0,this.scrollData.focusMode=!0,this.behaviorData.focusStartTime=Date.now();const e=document.createElement("div");e.style.cssText="\n      position: fixed; top: 20px; right: 20px; \n      background: linear-gradient(135deg, #10b981, #059669); \n      color: white; padding: 16px 24px; \n      border-radius: 12px; z-index: 999999;\n      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);\n      animation: slideInRight 0.3s ease;\n    ",e.innerHTML='\n      <div style="display: flex; align-items: center; gap: 12px;">\n        <span style="font-size: 20px;">üöÄ</span>\n        <div>\n          <div style="font-weight: 600;">Focus Mode Active</div>\n          <div style="font-size: 12px; opacity: 0.9;">Interventions paused for 25 minutes</div>\n        </div>\n      </div>\n    ',document.body.appendChild(e),setTimeout(()=>e.remove(),4e3),setTimeout(()=>{this.behaviorData.focusMode=!1,this.scrollData.focusMode=!1,console.log("üèÅ Focus session ended")},15e5),console.log("üöÄ Started enhanced focus session")}startBreakMode(){this.clearIntervention(),window.open("https://www.calm.com/breathe","_blank"),console.log("‚òï Started break mode")}clearIntervention(e=!0){e&&(this.behaviorData.interventionStage=0,this.scrollData.interventionStage=0),document.body.classList.remove("attention-trainer-dim","attention-trainer-pulse","attention-trainer-shake"),document.body.style.opacity="",document.body.style.overflow="";document.querySelectorAll(".attention-trainer-blur").forEach(e=>{e.classList.remove("attention-trainer-blur"),e.style.filter=""});const t=document.getElementById("attention-trainer-progress");t&&t.remove(),this.interventionOverlay&&(this.interventionOverlay.style.display="none");const n=document.querySelector(".breathing-reminder");n&&n.remove()}startFocusSession(){this.clearIntervention(),alert("Focus session started! Extension will be less intrusive for the next 25 minutes.")}detectSitePattern(){const e=window.location.hostname.toLowerCase(),t=(window.location.pathname.toLowerCase(),{"youtube.com":{type:"video",selectors:{content:"#contents, ytd-rich-grid-renderer",videos:"ytd-video-renderer, ytd-rich-item-renderer",infinite:"ytd-continuation-item-renderer"},triggers:["video_end","rapid_skip","homepage_scroll"],thresholds:{time:45,interactions:8,videos:3}},"instagram.com":{type:"social",selectors:{content:'main[role="main"], [role="main"]',posts:"article",infinite:'[data-testid="loader"]'},triggers:["rapid_scroll","story_binge","like_spam"],thresholds:{time:30,interactions:12,posts:5}},"tiktok.com":{type:"shortform",selectors:{content:'[data-e2e="recommend-list-container"]',videos:'[data-e2e="recommend-list-item-container"]',infinite:".tiktok-loading"},triggers:["rapid_swipe","video_binge","endless_feed"],thresholds:{time:20,interactions:15,videos:8}},"twitter.com":{type:"microblog",selectors:{content:'main[role="main"]',posts:'[data-testid="tweet"]',infinite:'[data-testid="loader"]'},triggers:["infinite_scroll","engagement_spiral","news_doom"],thresholds:{time:35,interactions:10,posts:8}},"x.com":{type:"microblog",selectors:{content:'main[role="main"]',posts:'[data-testid="tweet"]',infinite:'[data-testid="loader"]'},triggers:["infinite_scroll","engagement_spiral","news_doom"],thresholds:{time:35,interactions:10,posts:8}},"reddit.com":{type:"forum",selectors:{content:'[data-testid="post-container"], .Post',posts:'[data-testid="post-container"] > div, .Post',infinite:'.loading, [data-testid="loader"]'},triggers:["thread_dive","subreddit_hop","comment_spiral"],thresholds:{time:40,interactions:8,posts:6}},"facebook.com":{type:"social",selectors:{content:'[role="feed"], [data-pagelet="FeedUnit"]',posts:'[data-pagelet="FeedUnit_"]',infinite:'[data-testid="loading_indicator"]'},triggers:["feed_scroll","notification_chase","social_validation"],thresholds:{time:35,interactions:10,posts:6}},"linkedin.com":{type:"professional",selectors:{content:".feed-container, main",posts:".feed-shared-update-v2",infinite:".artdeco-spinner"},triggers:["network_fomo","content_consumption","job_anxiety"],thresholds:{time:25,interactions:6,posts:4}}});for(const[n,i]of Object.entries(t))if(e.includes(n.split(".")[0]))return console.log(`üéØ Detected ${i.type} site: ${n}`),i;return{type:"general",selectors:{content:'main, [role="main"], #main, .main-content',posts:"article, .post, .item",infinite:'.loading, .spinner, [class*="load"]'},triggers:["excessive_scroll","time_spent","aimless_browse"],thresholds:{time:60,interactions:15,posts:10}}}setupBehavioralAnalysis(){this.setupScrollAnalysis(),this.setupTimeTracking(),this.setupInteractionTracking(),this.setupContentConsumptionTracking(),this.setupSiteSpecificTracking(),console.log("üß† Advanced behavioral analysis activated")}setupScrollAnalysis(){let e=window.scrollY;const t=[],n=[];const i=()=>{if(!this.settings.isEnabled||this.behaviorData.focusMode)return;const i=window.scrollY,o=Math.abs(i-e),s=i>e?"down":"up";this.behaviorData.scrollPauseCount=o<10?(this.behaviorData.scrollPauseCount||0)+1:0,t.push(o),n.push(s),t.length>10&&t.shift(),n.length>10&&n.shift();t.reduce((e,t)=>e+t,0)/t.length>100&&this.behaviorData.rapidScrollCount++;n.reduce((e,t,i)=>i>0&&t!==n[i-1]?e+1:e,0)>6&&(this.behaviorData.backAndForthCount++,this.addBehaviorFlag("erratic_scrolling")),e=i,this.updateBehaviorScore()};let o;window.addEventListener("scroll",()=>{clearTimeout(o),o=setTimeout(i,50)},{passive:!0})}setupTimeTracking(){setInterval(()=>{if(!this.settings.isEnabled)return;this.behaviorData.totalTimeOnPage=Date.now()-this.behaviorData.sessionStart;this.behaviorData.totalTimeOnPage/6e4>this.sitePatterns.thresholds.time/60&&this.addBehaviorFlag("excessive_time"),(!this.behaviorData.lastInteractionTime||Date.now()-this.behaviorData.lastInteractionTime>1e4)&&(this.behaviorData.passiveConsumptionTime+=10),this.updateBehaviorScore()},1e4)}setupInteractionTracking(){let e=Date.now();const t=(t,n)=>{if(!this.settings.isEnabled)return;const i=Date.now();if("click"===t&&0,"key"===t&&0,i-e<500&&this.addBehaviorFlag("rapid_interaction"),n&&n.target){n.target.matches('a, button, input, textarea, [role="button"]')?this.addBehaviorFlag("productive_interaction"):this.addBehaviorFlag("passive_interaction")}this.behaviorData.lastInteractionTime=i,e=i,this.updateBehaviorScore()};document.addEventListener("click",e=>t("click",e),{passive:!0}),document.addEventListener("keydown",e=>t("key",e),{passive:!0})}setupContentConsumptionTracking(){const e=this.sitePatterns.selectors.content,t=this.sitePatterns.selectors.posts;if(!e||!t)return;const n=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&e.matches&&e.matches(t)&&this.trackContentConsumption(e)})})}),i=document.querySelector(e);i&&(n.observe(i,{childList:!0,subtree:!0}),this.observers.push(n))}setupSiteSpecificTracking(){switch(this.sitePatterns.type){case"video":this.setupVideoTracking();break;case"social":case"microblog":this.setupSocialTracking();break;case"shortform":this.setupShortFormTracking();break;case"forum":this.setupForumTracking()}}setupVideoTracking(){let e=Date.now();document.addEventListener("click",t=>{if(t.target.closest('ytd-video-renderer, ytd-rich-item-renderer, a[href*="/watch"]')){e=Date.now();Date.now()-e<1e4&&this.addBehaviorFlag("rapid_video_skip"),this.updateBehaviorScore()}})}setupSocialTracking(){document.addEventListener("click",e=>{e.target.matches('[data-testid*="like"], [aria-label*="Like"], .like-button')&&this.addBehaviorFlag("social_validation_seeking"),e.target.closest('article, [data-testid="tweet"]')&&0,this.updateBehaviorScore()})}setupShortFormTracking(){let e=0;document.addEventListener("touchstart",t=>{e=t.touches[0].clientY}),document.addEventListener("touchend",t=>{const n=t.changedTouches[0].clientY;Math.abs(e-n)>100&&(this.addBehaviorFlag("rapid_content_consumption"),this.updateBehaviorScore())})}setupForumTracking(){let e=0;document.addEventListener("click",t=>{t.target.closest('a[href*="/comments/"], a[href*="/r/"]')&&(e++,e>3&&this.addBehaviorFlag("deep_thread_dive"),this.updateBehaviorScore())})}trackContentConsumption(e){if(this.behaviorData.contentPieces=(this.behaviorData.contentPieces||0)+1,this.behaviorData.lastContentTime){Date.now()-this.behaviorData.lastContentTime<3e3&&this.addBehaviorFlag("rapid_consumption"),this.behaviorData.lastContentTime=Date.now()}else this.behaviorData.lastContentTime=Date.now();this.trackElementEngagement(e),this.updateBehaviorScore()}addBehaviorFlag(e){this.behaviorData.flags||(this.behaviorData.flags={}),this.behaviorData.flags[e]=(this.behaviorData.flags[e]||0)+1,console.log(`üö© Behavior flag: ${e} (${this.behaviorData.flags[e]})`)}trackElementEngagement(e){const t=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?this.addBehaviorFlag("content_viewed"):this.addBehaviorFlag("content_passed")})},{threshold:.5});t.observe(e),this.observers.push(t)}updateBehaviorScore(){let e=0;const t=this.behaviorData.totalTimeOnPage/6e4;t>5&&(e+=Math.min(2*(t-5),20));const n=this.behaviorData.flags||{};e+=5*(n.rapid_scrolling||0),e+=10*(n.erratic_scrolling||0),e+=3*(n.rapid_consumption||0),e+=2*(n.passive_interaction||0),e+=1*(n.content_passed||0),"social"!==this.sitePatterns.type&&"microblog"!==this.sitePatterns.type||(e+=5*(n.social_validation_seeking||0)),"video"===this.sitePatterns.type&&(e+=8*(n.rapid_video_skip||0)),e-=4*(n.productive_interaction||0),e-=2*(n.content_viewed||0),this.behaviorData.scrollPauseCount>2&&(e-=5*this.behaviorData.scrollPauseCount);const i=this.behaviorData.passiveConsumptionTime/(60*t);i>.5&&(e+=20*i),this.behaviorScore=Math.max(0,Math.min(e,100)),this.sendBehavioralAnalytics(),this.checkInterventionTriggers()}checkInterventionTriggers(){const e={social:{stage1:25,stage2:40,stage3:60,stage4:80},video:{stage1:30,stage2:50,stage3:70,stage4:85},forum:{stage1:20,stage2:35,stage3:55,stage4:75},microblog:{stage1:25,stage2:45,stage3:65,stage4:80},general:{stage1:40,stage2:60,stage3:80,stage4:90}}[this.sitePatterns.type||"general"];if(this.behaviorData.focusMode||this.behaviorData.snoozeUntil&&Date.now()<this.behaviorData.snoozeUntil)return;const t=Date.now();if(t-this.behaviorData.lastInterventionTime<3e4)return;let n=0;this.behaviorScore>=e.stage4?n=4:this.behaviorScore>=e.stage3?n=3:this.behaviorScore>=e.stage2?n=2:this.behaviorScore>=e.stage1&&(n=1),n>0&&n!==this.behaviorData.interventionStage&&(console.log(`üìä Behavior score: ${Math.round(this.behaviorScore)} ‚Üí Stage ${n}`),this.behaviorData.lastInterventionTime=t,this.triggerIntervention(n,this.settings.focusMode||"gentle"))}sendBehavioralAnalytics(){if(this.backgroundConnected&&this.contextValid)try{if(chrome.runtime.id){const e=this.behaviorData.totalTimeOnPage/6e4,t=this.behaviorData.totalTimeOnPage/1e3,n=Object.keys(this.behaviorData.flags||{}).reduce((e,t)=>t.includes("intervention")||this.behaviorData.interventionStage>0?e+1:e,this.behaviorData.interventionStage>0?1:0);chrome.runtime.sendMessage({type:"BEHAVIORAL_EVENT",data:{domain:window.location.hostname,siteType:this.sitePatterns.type,timeOnPage:e,scrollTime:t,behaviorScore:this.behaviorScore,flags:this.behaviorData.flags||{},scrollPauseCount:this.behaviorData.scrollPauseCount||0,contentPieces:this.behaviorData.contentPieces||0,interventionStage:this.behaviorData.interventionStage,interventionCount:n,rapidScrollCount:this.behaviorData.rapidScrollCount||0,backAndForthCount:this.behaviorData.backAndForthCount||0,passiveConsumptionTime:this.behaviorData.passiveConsumptionTime||0,focusMode:this.behaviorData.focusMode,timestamp:Date.now(),sessionStart:this.behaviorData.sessionStart}}).catch(e=>{e.message.includes("Extension context invalidated")&&(this.contextValid=!1)})}}catch(e){}}startBehaviorTracking(){setInterval(()=>{this.updateBehaviorScore()},5e3),console.log("üîÑ Behavior tracking started")}resetScrollData(){this.behaviorData={sessionStart:Date.now(),totalTimeOnPage:0,scrollSessions:[],currentScrollSession:null,rapidScrollCount:0,shortStayCount:0,backAndForthCount:0,passiveConsumptionTime:0,interventionStage:0,lastInterventionTime:0,flags:{},contentPieces:0},this.behaviorScore=0,this.clearIntervention(),console.log("üîÑ Behavioral data reset")}}function initializeExtension(){try{if(!chrome||!chrome.runtime||!chrome.runtime.id)return void console.warn("Extension context not available, skipping initialization");setTimeout(()=>{try{new AttentionTrainerContent}catch(e){console.error("Failed to initialize Attention Trainer content script:",e)}},500)}catch(e){console.warn("Chrome extension APIs not available:",e.message)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeExtension):initializeExtension();