class AttentionTrainerPopup{constructor(){this.settings={},this.init()}async init(){try{await this.loadSettings(),this.setupEventListeners(),this.updateUI(),this.loadTodayStats()}catch(t){console.error("Failed to initialize popup:",t),this.showError("Failed to load extension data")}}async loadSettings(){try{const t=await chrome.runtime.sendMessage({type:"GET_SETTINGS"});this.settings=t||{isEnabled:!0,focusMode:"gentle",analytics:{dailyStats:{}}}}catch(t){console.error("Failed to load settings:",t),this.settings={isEnabled:!0,focusMode:"gentle",analytics:{dailyStats:{}}},this.showError("Could not connect to background script")}}setupEventListeners(){document.getElementById("mainToggle").addEventListener("click",()=>{this.toggleExtension()}),document.querySelectorAll('input[name="focusMode"]').forEach(t=>{t.addEventListener("change",t=>{this.updateFocusMode(t.target.value)})}),document.getElementById("openDashboard").addEventListener("click",()=>{chrome.runtime.sendMessage({type:"OPEN_DASHBOARD"}),window.close()}),document.getElementById("manageWhitelist").addEventListener("click",()=>{this.showWhitelistDialog()})}updateUI(){const t=document.getElementById("mainToggle");this.settings.isEnabled?t.classList.add("active"):t.classList.remove("active"),document.querySelector(`input[value="${this.settings.focusMode}"]`).checked=!0}async toggleExtension(){try{this.settings.isEnabled=!this.settings.isEnabled;const t=await chrome.runtime.sendMessage({type:"UPDATE_SETTINGS",data:{isEnabled:this.settings.isEnabled}});if(t&&!t.success)throw new Error(t.error||"Failed to update settings");this.updateUI()}catch(t){console.error("Failed to toggle extension:",t),this.settings.isEnabled=!this.settings.isEnabled,this.showError("Failed to update extension settings")}}async updateFocusMode(t){try{this.settings.focusMode=t;const e=await chrome.runtime.sendMessage({type:"UPDATE_SETTINGS",data:{focusMode:t}});if(e&&!e.success)throw new Error(e.error||"Failed to update focus mode")}catch(t){console.error("Failed to update focus mode:",t),this.showError("Failed to update focus mode")}}async loadTodayStats(){const t=(new Date).toISOString().split("T")[0],e=this.settings.analytics?.dailyStats?.[t]||{};let s=0,n=0,i=0,o=0;Object.values(e).forEach(t=>{const e=t.timeOnPage||t.scrollTime||0;s+=e,n+=t.interventions||0,t.behaviorScore>0&&(i+=t.behaviorScore,o++)}),i=o>0?i/o:0;const a=Math.round(s/(s>60?60:1));document.getElementById("todayScrollTime").textContent=`${a}m`,document.getElementById("todayInterventions").textContent=n;const d=Math.max(0,100-8*n-.3*i);document.getElementById("focusScore").textContent=`${Math.round(d)}%`}showWhitelistDialog(){chrome.tabs.query({active:!0,currentWindow:!0},t=>{const e=new URL(t[0].url).hostname,s=this.settings.whitelist.includes(e);confirm(`${s?"Remove from":"Add to"} whitelist: ${e}?`)&&this.toggleWhitelist(e)})}async toggleWhitelist(t){const e=[...this.settings.whitelist],s=e.indexOf(t);s>-1?e.splice(s,1):e.push(t),await chrome.runtime.sendMessage({type:"UPDATE_SETTINGS",data:{whitelist:e}}),this.settings.whitelist=e}showError(t){const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 10px;\n      left: 10px;\n      right: 10px;\n      background: #fee;\n      color: #c53030;\n      padding: 8px;\n      border-radius: 4px;\n      font-size: 12px;\n      z-index: 1000;\n    ",e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}}new AttentionTrainerPopup;